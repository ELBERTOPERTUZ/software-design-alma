<%= form_with url: "/#{I18n.locale}/admin/users/bulk_delete", method: :delete do %>
  <div class="table-responsive table-personalized">
  <table class="table table-hover align-middle mb-0">
    <thead>
    <tr id="selection-bar" class="d-none">
      <th colspan="7" class="text-white bg-selected px-4 rounded">
        <div class="d-flex justify-content-between align-items-center w-100">
          <span id="selection-count"></span>
          <button type="submit" class="btn p-0 border-0 bg-transparent text-danger">
            <i class="bi bi-trash-fill fs-4 hover-opacity"></i>
          </button>
        </div>
      </th>
    </tr>
    <tr class="table-light no-thead-border">
          <th id="selection-header" style="width: 2%;"><input type="checkbox" id="select-all"></th>
          <th style="width: 50%;">Nombre</th>
          <th class="d-none d-md-table-cell text-center text-nowrap" style="width: 10%;">Ciudad</th>
          <th class="d-none d-md-table-cell text-center text-nowrap" style="width: 10%;">Dirección</th>
          <th class="d-none d-md-table-cell text-center text-nowrap" style="width: 10%;">Creado</th>
          <th class="d-none d-md-table-cell text-center text-nowrap" style="width: 10%;">Rol</th>
          <th class="d-none d-md-table-cell text-center text-nowrap" style="width: 10%;">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <% @users.each do |user| %>
          <tr>
            <td><input type="checkbox" name="selected_users[]" value="<%= user.id %>" class="user-checkbox"></td>
            <!-- Columna visible en todas las pantallas -->
            <td>
              <div class="fw-bold"><%= user.name %> <%= user.last_name %></div>
              <div class="text-muted small"><%= user.email %></div>

              <!-- Ícono de teléfono en móviles -->
              <div class="d-md-none mt-2">
                <i class="bi bi-phone-fill text-primary fs-4"></i>
              </div>
            </td>

            <!-- Estas columnas solo en pantallas grandes -->
            <td class="d-none d-md-table-cell text-center text-nowrap px-1"><%= user.city %></td>
            <td class="d-none d-md-table-cell text-center text-nowrap px-1"><%= user.address %></td>
            <td class="d-none d-md-table-cell text-center text-nowrap px-1"><%= user.created_at.strftime("%Y-%m-%d") %></td>
            <td class="d-none d-md-table-cell text-center text-nowrap px-1">
              <span class="badge <%= user.admin? ? 'bg-danger-ok' : 'bg-secondary-ok' %>">
                <%= user.admin? ? "Admin" : "User" %>
              </span>
            </td>
            <td class="text-end d-none d-md-table-cell text-nowrap px-1">
              <div class="d-flex justify-content-center align-items-center">
                <%= link_to admin_user_path(user), class: 'text-decoration-none text-body mx-1', title: 'Ver' do %>
                  <i class="bi bi-eye-fill fs-4 hover-opacity"></i>
                <% end %>

                <%= button_to admin_user_path(user),
                    method: :delete,
                    form: { data: { turbo: false } },
                    data: { confirm: '¿Estás seguro?' },
                    class: 'btn p-0 border-0 bg-transparent text-danger mx-1',
                    title: 'Eliminar' do %>
                  <i class="bi bi-trash-fill fs-4 hover-opacity"></i>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

<div class="mt-4 text-end">
  <%= link_to new_admin_user_path, class: 'btn btn-success' do %>
    <i class="bi bi-plus-circle"></i> Agregar Usuario
  <% end %>
</div>

<script>
  document.addEventListener("turbo:load", function () {
    const selectAll = document.getElementById("select-all");
    const checkboxes = document.querySelectorAll(".user-checkbox");
    const selectionBar = document.getElementById("selection-bar");
    const selectionCount = document.getElementById("selection-count");

    function updateSelectionUI() {
      const selected = document.querySelectorAll(".user-checkbox:checked").length;

      if (selected > 0) {
        selectionBar.classList.remove("d-none");
        selectionCount.textContent = `${selected} seleccionados`;
      } else {
        selectionBar.classList.add("d-none");
        selectionCount.textContent = "";
      }
    }

    if (selectAll) {
      selectAll.addEventListener("change", function () {
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
        updateSelectionUI();
      });
    }

    checkboxes.forEach(cb => {
      cb.addEventListener("change", () => {
        selectAll.checked = [...checkboxes].every(c => c.checked);
        updateSelectionUI();
      });
    });

    updateSelectionUI();
  });
</script>
